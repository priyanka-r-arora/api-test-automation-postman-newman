name: API Tests

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests'
        required: true
        default: 'QA'
        type: choice
        options: [DEV, QA, PROD]
      test_suite:
        description: 'Test suite'
        required: true
        default: 'all'
        type: choice
        options: [smoke, all, negative]

env:
  NODE_VERSION: '18'

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'QA' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install deps
        run: npm ci
      
      - name: Run smoke tests
        env:
          GOREST_AUTH_TOKEN: ${{ secrets.GOREST_AUTH_TOKEN }}
          REQRES_API_KEY: ${{ secrets.REQRES_API_KEY }}
          TEST_ENV: ${{ github.event.inputs.environment || 'QA' }}
        run: npm run test:smoke
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-report
          path: reports/smoke-test-report.html
          retention-days: 30

  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    environment: ${{ github.event.inputs.environment || 'QA' }}
    if: github.event_name != 'pull_request' || github.event.inputs.test_suite == 'all'
    
    strategy:
      fail-fast: false
      matrix:
        collection:
          - name: User Management
            report: users
          - name: Posts & Comments
            report: posts
          - name: E2E Journey
            report: e2e
          - name: Negative Scenarios
            report: negative
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install deps
        run: npm ci
      
      - name: Run ${{ matrix.collection.name }}
        env:
          GOREST_AUTH_TOKEN: ${{ secrets.GOREST_AUTH_TOKEN }}
          REQRES_API_KEY: ${{ secrets.REQRES_API_KEY }}
          TEST_ENV: ${{ github.event.inputs.environment || 'QA' }}
        run: npm run test:${{ matrix.collection.report }}
        continue-on-error: true
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.collection.report }}-report
          path: reports/${{ matrix.collection.report }}-report.html
          retention-days: 30

  data-driven-tests:
    name: Data-Driven Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    environment: ${{ github.event.inputs.environment || 'QA' }}
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install deps
        run: npm ci
      
      - name: Run data-driven tests
        env:
          GOREST_AUTH_TOKEN: ${{ secrets.GOREST_AUTH_TOKEN }}
          REQRES_API_KEY: ${{ secrets.REQRES_API_KEY }}
          TEST_ENV: ${{ github.event.inputs.environment || 'QA' }}
        run: npm run test:data-driven
        continue-on-error: true
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: data-driven-report
          path: reports/data-driven-report.html
          retention-days: 30

  consolidate-reports:
    name: Consolidate Reports
    runs-on: ubuntu-latest
    needs: [regression-tests]
    if: always()
    
    steps:
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports
      
      - name: Upload combined reports
        uses: actions/upload-artifact@v4
        with:
          name: all-test-reports
          path: all-reports/
          retention-days: 60

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests]
    if: failure() && github.event_name != 'pull_request'
    
    steps:
      - name: Log failure
        run: |
          echo "::warning::Tests failed in ${{ github.workflow }}"
          echo "Run: ${{ github.run_id }}"
